name: "Deploy code to an Astro Cloud Dpeloyment"
description: "Deploys your Astro project to an Astro Cloud Deployment. Works with DAG-Only Deploys enabled or disabled."
inputs:
  dag-deploy-enabled:
    required: false
    default: false
    description: "If true only DAGs will be deployed when dag files are pushed."
  dag-folder:
    required: false
    default: dags/
    description: "Path to dag folder."
  parse:
    required: false
    default: false
    description: "If true DAGs will be parsed before deploying to Astro."
  pytest:
    required: false
    default: false
    description: "if true custom Pytests will be ran before deploying to Astro."
  pytest-file:
    required: false
    description: "Specify custom Pytest files to run with the pytest command."
  force:
    required: false
    default: false
    description: "Will force deploy your code to Astornomer. Skips parse test on image deploys."
runs:
  using: "composite"
  steps:
    - name: checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    # Determine if only DAGs have changes 
    - name: Get Deployment Type
      run: |
        files=$(git diff --name-only HEAD^..HEAD)
        dags_only=1

        for file in $files; do
          if [[ $file != "${{ inputs.dag-folder }}"* ]]; then
            echo $file is not a dag, triggering a full image build
            dags_only=0
            break
          fi
        done

        if [[ ${{ inputs.dag-deploy-enabled }} == false ]]; then
          dags_only=0
        fi

        echo "DAGS_ONLY=$dags_only" >> $GITHUB_OUTPUT
      shell: bash
      id: deployment-type
    # If only DAGs changed and dag deploys is enabled, do a DAG-only deploy
    - name: setup deploy options
      run: |
        options=""
        if [[ ${{ inputs.parse }} == true ]]; then
          options="--parse"
        fi

        if [[ ${{ inputs.pytest }} == true ]]; then
          options="--pytest --pytest-file ${{ inputs.pytest-file }}"
        fi

        if [[ ${{ inputs.parse }} == true && ${{ inputs.pytest }} == true ]]; then
          options="--parse --pytest --pytest-file ${{ inputs.pytest-file }}"
        fi
        echo $options
        echo "OPTIONS=$options" >> $GITHUB_OUTPUT
      shell: bash
      id: deploy-options
    - name: DAG Deploy to Astro
      if: steps.deployment-type.outputs.DAGS_ONLY == 1
      run: |
        curl -sSL https://install.astronomer.io | sudo bash -s
        astro deploy --dags ${{steps.deploy-options.outputs.OPTIONS}}
      shell: bash
    # If any other files changed or dag deploys is disabled, deploy the entire Astro project
    - name: Image and DAG Deploy to Astro
      if: steps.deployment-type.outputs.DAGS_ONLY == 0
      run: |
        curl -sSL https://install.astronomer.io | sudo bash -s

        if [[ ${{ inputs.force }} == true ]]; then
          astro deploy ${{steps.deploy-options.outputs.OPTIONS}} -f
        else
          astro deploy ${{steps.deploy-options.outputs.OPTIONS}}
        fi
      shell: bash
  